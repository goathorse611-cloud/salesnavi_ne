<script>
// ========================================
// Application State
// ========================================
const App = {
  state: {
    currentProjectId: null,
    currentProject: null,
    projects: [],
    usecases: [],
    raciEntries: [],
    values: [],
    selectedUsecases: [],
    currentView: 'home',
    projectFilter: 'all',
    governanceEntries: [],
    // 90日計画の状態
    ninetyDayPlan: {
      phases: {
        ignite: { objective: '', milestones: [], successCriteria: '' },
        strengthen: { objective: '', milestones: [], successCriteria: '' },
        establish: { objective: '', milestones: [], successCriteria: '' }
      },
      roles: [],
      requiredData: [],
      risks: [],
      communication: { meetingFrequency: 'weekly', stakeholders: '', reporting: '' }
    },
    // 成熟度レベルの状態
    maturityLevel: null,
    maturityTemplates: null
  },

  // ========================================
  // Initialization
  // ========================================
  init() {
    this.setupUserAvatar();
    this.loadProjects();
    this.setupEventListeners();
    this.setupVisionPreview();
  },

  setupUserAvatar() {
    const email = document.getElementById('user-name')?.textContent || '';
    const avatar = document.getElementById('user-avatar');
    if (avatar && email) {
      avatar.textContent = email.charAt(0).toUpperCase();
    }
  },

  setupEventListeners() {
    // Project search
    const searchInput = document.getElementById('project-search');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        this.filterProjectsBySearch(e.target.value);
      });
    }

    // Vision text counter
    const visionText = document.getElementById('vision-text');
    if (visionText) {
      visionText.addEventListener('input', () => {
        this.updateVisionCount();
        this.updateVisionPreview();
      });
    }

    const visionRules = document.getElementById('vision-rules');
    if (visionRules) {
      visionRules.addEventListener('input', () => this.updateVisionPreview());
    }

    const visionMetrics = document.getElementById('vision-metrics');
    if (visionMetrics) {
      visionMetrics.addEventListener('input', () => this.updateVisionPreview());
    }
  },

  setupVisionPreview() {
    this.updateVisionCount();
    this.updateVisionPreview();
  },

  // ========================================
  // Navigation
  // ========================================
  navigate(viewName) {
    // Hide all views
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

    // Show target view
    const target = document.getElementById('view-' + viewName);
    if (target) {
      target.classList.remove('hidden');
    }

    // Update navigation state
    this.state.currentView = viewName;
    this.updateNavigation(viewName);
    this.updateBreadcrumb(viewName);

    // Load view-specific data
    if (this.state.currentProjectId) {
      switch (viewName) {
        case 'vision':
          this.loadVision();
          break;
        case 'usecases':
          this.loadUsecases();
          break;
        case '90days':
          this.load90DayPlan();
          break;
        case 'raci':
          this.loadRACIEntries();
          break;
        case 'value':
          this.loadValues();
          break;
        case 'coreprocess':
          this.loadCoreProcess();
          break;
        case 'governance':
          this.loadGovernance();
          break;
        case 'operations':
          this.loadOperationsSupport();
          break;
      }
    }

    // Scroll to top
    document.getElementById('main-content')?.scrollTo(0, 0);
    return false;
  },

  updateNavigation(viewName) {
    // Remove active state from all nav items
    document.querySelectorAll('[data-nav]').forEach(item => {
      item.className = 'nav-item';
    });

    // Add active state to current nav item
    const activeNav = document.querySelector(`[data-nav="${viewName}"]`);
    if (activeNav) {
      activeNav.className = 'nav-item-active';
    }

    // Show/hide project nav
    const projectNav = document.getElementById('project-nav');
    if (projectNav) {
      projectNav.classList.toggle('hidden', !this.state.currentProjectId);
    }
  },

  updateBreadcrumb(viewName) {
        const titles = {
      'home': 'ホーム',
      'projects': 'プロジェクト一覧',
      'project-detail': this.state.currentProject?.customerName || 'プロジェクト',
      'vision': 'ビジョン（モジュール 1）',
      'usecases': 'ユースケース選定（モジュール 2）',
      '90days': '90日計画（モジュール 2）',
      'raci': '体制・RACI（モジュール 4）',
      'value': '価値トラッカー（モジュール 7）',
      'coreprocess': 'ギャップ診断（モジュール 3）',
      'governance': '統制（モジュール 5）',
      'operations': '運営支援（モジュール 6）'
    };
    const breadcrumbTitle = document.getElementById('breadcrumb-title');
    if (breadcrumbTitle) {
      breadcrumbTitle.textContent = titles[viewName] || 'Home';
    }
  },

  toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      sidebar.classList.toggle('hidden');
    }
  },

  // ========================================
  // Projects
  // ========================================
  loadProjects() {
    google.script.run
      .withSuccessHandler((response) => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('app').classList.add('flex');

        if (!response.success) {
          this.showError(response.error);
          return;
        }

        this.state.projects = response.data || [];
        this.renderRecentProjects();
        this.renderProjectsList();
      })
      .withFailureHandler((error) => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        this.showError(error.message);
      })
      .apiGetUserProjects();
  },

  renderRecentProjects() {
    const container = document.getElementById('recent-projects-list');
    if (!container) return;

    const recent = this.state.projects.slice(0, 5);

    if (recent.length === 0) {
      container.innerHTML = `
        <div class="px-6 py-8 text-center text-slate-500">
                    <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">folder_open</span>
          <p>プロジェクトがまだありません。最初のプロジェクトを作成してください。</p>
        </div>
      `;
      return;
    }

    container.innerHTML = recent.map(project => this.renderProjectRow(project)).join('');
  },

  renderProjectsList() {
    const container = document.getElementById('projects-list');
    if (!container) return;

    let filtered = this.state.projects;

    // Apply filter
    if (this.state.projectFilter !== 'all') {
      const filterMap = {
        'draft': 'Draft',
        'confirmed': 'Confirmed',
        'archived': 'Archived'
      };
      filtered = filtered.filter(p => p.status === filterMap[this.state.projectFilter]);
    }

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="bg-white rounded-lg border border-slate-200 shadow-card p-8 text-center text-slate-500">
                    <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">search_off</span>
          <p>現在のフィルターに一致するプロジェクトが見つかりません。</p>
        </div>
      `;
      return;
    }

    container.innerHTML = filtered.map(project => this.renderProjectCard(project)).join('');
  },

  renderProjectRow(project) {
    const statusClass = this.getStatusClass(project.status);
    return `
      <div onclick="App.selectProject('${project.projectId}')" class="grid grid-cols-12 gap-4 px-6 py-4 hover:bg-slate-50 cursor-pointer transition-colors items-center">
        <div class="col-span-6 md:col-span-5 flex items-center gap-3">
          <div class="size-9 bg-slate-100 rounded-lg flex items-center justify-center text-slate-500 shrink-0">
            <span class="material-symbols-outlined text-[18px]">domain</span>
          </div>
          <span class="font-semibold text-slate-900 truncate">${this.escapeHtml(project.customerName)}</span>
        </div>
        <div class="col-span-3 md:col-span-3 text-sm text-slate-500">${this.formatDate(project.updatedDate || project.createdDate)}</div>
        <div class="col-span-3 md:col-span-2">
          <span class="${statusClass}">${project.status}</span>
        </div>
        <div class="hidden md:flex md:col-span-2 justify-end">
                    <button class="text-primary hover:text-primary-dark text-sm font-medium flex items-center gap-1">
            開く
            <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
          </button>
        </div>
      </div>
    `;
  },

  renderProjectCard(project) {
    const statusClass = this.getStatusClass(project.status);
    return `
      <div onclick="App.selectProject('${project.projectId}')" class="bg-white rounded-lg border border-slate-200 shadow-card p-5 hover:shadow-card-hover hover:border-primary/30 transition-all cursor-pointer">
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="size-10 bg-slate-100 rounded-lg flex items-center justify-center text-slate-500">
              <span class="material-symbols-outlined">domain</span>
            </div>
            <div>
              <h3 class="font-bold text-slate-900">${this.escapeHtml(project.customerName)}</h3>
                            <p class="text-xs text-slate-500">作成日 ${this.formatDate(project.createdDate)}</p>
            </div>
          </div>
          <span class="${statusClass}">${project.status}</span>
        </div>
        <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-500">最終更新: ${this.formatDate(project.updatedDate || project.createdDate)}</span>
          <button class="text-primary hover:text-primary-dark font-medium flex items-center gap-1">
            開く
            <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
          </button>
        </div>
      </div>
    `;
  },

  getStatusClass(status) {
    const classes = {
      'Draft': 'px-2 py-0.5 rounded text-[11px] font-bold bg-amber-50 text-amber-700 border border-amber-200',
      'Confirmed': 'px-2 py-0.5 rounded text-[11px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-200',
      'Archived': 'px-2 py-0.5 rounded text-[11px] font-bold bg-slate-100 text-slate-600 border border-slate-200'
    };
    return classes[status] || classes['Draft'];
  },



  filterProjects(filter) {
    this.state.projectFilter = filter;

    // Update filter tabs UI
    document.querySelectorAll('.filter-tab').forEach(tab => {
      if (tab.dataset.filter === filter) {
        tab.className = 'filter-tab px-4 py-1.5 rounded bg-white text-primary shadow-sm text-sm font-semibold whitespace-nowrap';
      } else {
        tab.className = 'filter-tab px-4 py-1.5 rounded hover:bg-white/50 text-slate-600 text-sm font-medium whitespace-nowrap transition-colors';
      }
    });

    this.renderProjectsList();
  },

  filterProjectsBySearch(query) {
    const container = document.getElementById('projects-list');
    if (!container) return;

    let filtered = this.state.projects;

    if (query) {
      const lowerQuery = query.toLowerCase();
      filtered = filtered.filter(p =>
        p.customerName.toLowerCase().includes(lowerQuery)
      );
    }

    if (this.state.projectFilter !== 'all') {
      const filterMap = {
        'draft': 'Draft',
        'confirmed': 'Confirmed',
        'archived': 'Archived'
      };
      filtered = filtered.filter(p => p.status === filterMap[this.state.projectFilter]);
    }

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="bg-white rounded-lg border border-slate-200 shadow-card p-8 text-center text-slate-500">
                    <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">search_off</span>
          <p>「${this.escapeHtml(query)}」に一致するプロジェクトが見つかりません</p>
        </div>
      `;
      return;
    }

    container.innerHTML = filtered.map(project => this.renderProjectCard(project)).join('');
  },

  selectProject(projectId) {
    this.state.currentProjectId = projectId;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

        this.state.currentProject = response.data;
        this.navigate('project-detail');
        this.renderProjectDetail();
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiGetProject(projectId);
  },

  renderProjectDetail() {
    const project = this.state.currentProject;
    if (!project) return;

    document.getElementById('project-title').textContent = project.customerName;
    document.getElementById('project-updated').textContent = this.formatDate(project.updatedDate || project.createdDate);
    document.getElementById('project-owner').textContent = project.createdBy || project.creatorEmail || 'Unknown';

    // Render module cards
    this.renderModuleCards();
  },

  renderModuleCards() {
    const container = document.getElementById('module-cards');
    if (!container) return;

        const modules = [
      { id: 'vision', num: 1, title: 'ビジョン', icon: 'flag', desc: '北極星ビジョンを定義' },
      { id: 'usecases', num: 2, title: 'ユースケース', icon: 'checklist', desc: '戦略的ユースケースを選定' },
      { id: '90days', num: 3, title: '90日計画', icon: 'calendar_month', desc: '実装ロードマップを作成' },
      { id: 'raci', num: 4, title: '体制・RACI', icon: 'group', desc: '役割と責任を定義' },
      { id: 'value', num: 7, title: '価値トラッカー', icon: 'trending_up', desc: '成果を追跡・検証' }
    ];

    container.innerHTML = modules.map(m => `
      <div onclick="App.navigate('${m.id}')" class="bg-white rounded-lg border border-slate-200 shadow-card p-5 hover:shadow-card-hover hover:border-primary/30 transition-all cursor-pointer group">
        <div class="flex items-center justify-between mb-3">
          <div class="size-10 rounded-md bg-primary-light text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">${m.icon}</span>
          </div>
                    <span class="px-2 py-0.5 rounded text-[11px] font-bold bg-slate-100 text-slate-600">モジュール ${m.num}</span>
        </div>
        <h3 class="font-bold text-slate-900 mb-1">${m.title}</h3>
        <p class="text-sm text-slate-500">${m.desc}</p>
      </div>
    `).join('');
  },

  showNewProjectModal() {
    document.getElementById('modal-new-project').classList.remove('hidden');
    document.getElementById('new-project-name').focus();
  },

  closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
  },

  createProject() {
    const name = document.getElementById('new-project-name').value.trim();
    if (!name) {
            alert('顧客名を入力してください');
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

        this.closeModal('modal-new-project');
        document.getElementById('new-project-name').value = '';
                this.showSuccess('プロジェクトを作成しました');
        this.loadProjects();
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiCreateProject(name);
  },

  confirmProject() {
    if (!this.state.currentProjectId) return;

        if (!confirm('このプロジェクトを確定しますか？この操作は取り消せません。')) {
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

                this.showSuccess('プロジェクトを確定しました');
        this.selectProject(this.state.currentProjectId);
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiUpdateProjectStatus(this.state.currentProjectId, 'Confirmed');
  },

  // ========================================
  // Vision (Module 1)
  // ========================================
  loadVision() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        const vision = response.data;
        if (vision) {
          document.getElementById('vision-text').value = vision.visionText || '';
          document.getElementById('vision-rules').value = vision.decisionRules || '';
          document.getElementById('vision-metrics').value = vision.successMetrics || '';
          document.getElementById('vision-notes').value = vision.notes || '';
          this.updateVisionCount();
          this.updateVisionPreview();
        }
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetVision(this.state.currentProjectId);
  },

  saveVision() {
    if (!this.state.currentProjectId) return;

    const visionData = {
      projectId: this.state.currentProjectId,
      visionText: document.getElementById('vision-text').value.trim(),
      decisionRules: document.getElementById('vision-rules').value.trim(),
      successMetrics: document.getElementById('vision-metrics').value.trim(),
      notes: document.getElementById('vision-notes').value.trim()
    };

    if (!visionData.visionText) {
            alert('ビジョンステートメントを入力してください');
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

        this.showSaveStatus();
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveVision(visionData);
  },

  updateVisionCount() {
    const text = document.getElementById('vision-text')?.value || '';
    const count = document.getElementById('vision-count');
    if (count) {
      count.textContent = `${text.length}/200`;
    }
  },

  updateVisionPreview() {
    const vision = document.getElementById('vision-text')?.value || '';
    const rules = document.getElementById('vision-rules')?.value || '';
    const metrics = document.getElementById('vision-metrics')?.value || '';

    const previewVision = document.getElementById('preview-vision');
    const previewRules = document.getElementById('preview-rules');
    const previewMetrics = document.getElementById('preview-metrics');

    if (previewVision) {
            previewVision.textContent = vision ? `"${vision}"` : '"ここにビジョンが表示されます..."';
    }

    if (previewRules) {
      if (rules) {
        const lines = rules.split('\n').filter(l => l.trim());
        previewRules.innerHTML = lines.map(l => `<p class="flex items-start gap-2"><span class="text-primary">-</span>${this.escapeHtml(l)}</p>`).join('');
      } else {
                previewRules.innerHTML = '<p class="text-slate-400">ルール未定義...</p>';
      }
    }

    if (previewMetrics) {
      if (metrics) {
        const lines = metrics.split('\n').filter(l => l.trim());
        previewMetrics.innerHTML = lines.map(l => `<p class="flex items-start gap-2"><span class="text-primary">-</span>${this.escapeHtml(l)}</p>`).join('');
      } else {
                previewMetrics.innerHTML = '<p class="text-slate-400">指標未定義...</p>';
      }
    }
  },

  completeModule(moduleName) {
    this.saveVision();
    this.showSuccess(`${moduleName.charAt(0).toUpperCase() + moduleName.slice(1)} module completed`);
    // Navigate to next module
    const nextModule = {
      'vision': 'usecases',
      'usecases': '90days',
      '90days': 'raci',
      'raci': 'value'
    };
    if (nextModule[moduleName]) {
      setTimeout(() => this.navigate(nextModule[moduleName]), 500);
    }
  },

  // ========================================
  // Use Cases (Module 2 Part A)
  // ========================================
  loadUsecases() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        this.state.usecases = response.data || [];
        this.renderUsecasesTable();
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetUsecases(this.state.currentProjectId);
  },

  renderUsecasesTable() {
    const tbody = document.getElementById('usecases-table-body');
    if (!tbody) return;

    if (this.state.usecases.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-slate-500">
                        <span class="material-symbols-outlined text-4xl text-slate-300 mb-2 block">assignment</span>
            ユースケースがまだありません。「ユースケース追加」をクリックして作成してください。
          </td>
        </tr>
      `;
      return;
    }

    // Sort by score
    const sorted = [...this.state.usecases].sort((a, b) => (b.score || 0) - (a.score || 0));

    tbody.innerHTML = sorted.map((uc, index) => {
      const impact = Math.ceil((uc.score || 50) / 20) || 3;
      const feasibility = 3;
      const capability = 3;
      const total = (impact * 0.4 + feasibility * 0.3 + capability * 0.3) * 20;
      const isSelected = this.state.selectedUsecases.includes(uc.usecaseId);

      return `
        <tr class="hover:bg-slate-50 transition-colors ${isSelected ? 'bg-blue-50/50' : ''}">
          <td class="px-6 py-4">
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-slate-800">${this.escapeHtml(uc.goal)}</span>
              <span class="text-xs text-slate-500 line-clamp-1">${this.escapeHtml(uc.challenge)}</span>
            </div>
          </td>
          <td class="px-4 py-4">
            <div class="flex flex-col gap-1.5">
              <input type="range" min="1" max="5" value="${impact}" class="w-full" data-id="${uc.usecaseId}" data-type="impact"/>
              <span class="text-xs font-bold text-slate-700 text-center">${impact}</span>
            </div>
          </td>
          <td class="px-4 py-4">
            <div class="flex flex-col gap-1.5">
              <input type="range" min="1" max="5" value="${feasibility}" class="w-full" data-id="${uc.usecaseId}" data-type="feasibility"/>
              <span class="text-xs font-bold text-slate-700 text-center">${feasibility}</span>
            </div>
          </td>
          <td class="px-4 py-4">
            <div class="flex flex-col gap-1.5">
              <input type="range" min="1" max="5" value="${capability}" class="w-full" data-id="${uc.usecaseId}" data-type="capability"/>
              <span class="text-xs font-bold text-slate-700 text-center">${capability}</span>
            </div>
          </td>
          <td class="px-4 py-4 text-center border-l border-slate-100">
            <span class="text-lg font-bold text-primary">${total.toFixed(0)}</span>
          </td>
          <td class="px-4 py-4 text-center">
            <span class="inline-flex items-center justify-center size-7 rounded-full ${index < 2 ? 'bg-primary text-white' : 'bg-slate-100 text-slate-600'} text-sm font-bold">${index + 1}</span>
          </td>
          <td class="px-6 py-4 text-center bg-blue-50/30">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="App.toggleUsecaseSelection('${uc.usecaseId}')" class="w-5 h-5 text-primary rounded border-slate-300 focus:ring-primary cursor-pointer"/>
          </td>
        </tr>
      `;
    }).join('');

    this.updateSelectionCount();
  },

  toggleUsecaseSelection(usecaseId) {
    const idx = this.state.selectedUsecases.indexOf(usecaseId);
    if (idx === -1) {
      if (this.state.selectedUsecases.length >= 2) {
                alert('ユースケースは2件まで選択できます');
        this.renderUsecasesTable();
        return;
      }
      this.state.selectedUsecases.push(usecaseId);
    } else {
      this.state.selectedUsecases.splice(idx, 1);
    }
    this.renderUsecasesTable();
  },

  updateSelectionCount() {
    const countEl = document.getElementById('selected-count');
    if (countEl) {
      countEl.textContent = this.state.selectedUsecases.length;
    }
  },

  toggleUsecaseForm() {
    const panel = document.getElementById('usecase-input-panel');
    const btn = document.getElementById('btn-toggle-usecase-form');
    if (panel.classList.contains('hidden')) {
      panel.classList.remove('hidden');
      btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">close</span>閉じる';
      document.getElementById('new-usecase-challenge').focus();
      this.calculateImpact();
    } else {
      panel.classList.add('hidden');
      btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">add</span>ユースケース追加';
    }
  },

  calculateImpact() {
    const users = parseInt(document.getElementById('calc-users').value) || 0;
    const minutes = parseInt(document.getElementById('calc-minutes').value) || 0;
    const hourlyRate = parseInt(document.getElementById('calc-hourly-rate').value) || 0;
    const workdays = parseInt(document.getElementById('calc-workdays').value) || 0;

    const monthlyHours = (minutes / 60) * workdays * users;
    const monthlyImpact = Math.round(monthlyHours * hourlyRate);
    const annualImpact = monthlyImpact * 12;

    document.getElementById('calc-monthly-impact').textContent = '¥' + monthlyImpact.toLocaleString();
    document.getElementById('calc-annual-impact').textContent = '¥' + annualImpact.toLocaleString();

    return { users, minutes, hourlyRate, workdays, monthlyImpact, annualImpact };
  },

  addUsecase() {
    if (!this.state.currentProjectId) return;

    const impactCalc = this.calculateImpact();
    const impactText = document.getElementById('new-usecase-impact').value.trim();
    const calcSummary = `年間効果: ¥${impactCalc.annualImpact.toLocaleString()}（対象${impactCalc.users}人 × ${impactCalc.minutes}分/日削減 × 時給${impactCalc.hourlyRate}円 × ${impactCalc.workdays}日/月）`;
    const expectedImpact = impactText ? `${calcSummary}\n${impactText}` : calcSummary;

    const usecaseData = {
      projectId: this.state.currentProjectId,
      challenge: document.getElementById('new-usecase-challenge').value.trim(),
      goal: document.getElementById('new-usecase-goal').value.trim(),
      expectedImpact: expectedImpact,
      ninetyDayGoal: document.getElementById('new-usecase-90day').value.trim(),
      score: 50,
      priority: this.state.usecases.length + 1
    };

    if (!usecaseData.challenge || !usecaseData.goal) {
      alert('課題と狙いの両方を入力してください');
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

        this.toggleUsecaseForm();
        document.getElementById('new-usecase-challenge').value = '';
        document.getElementById('new-usecase-goal').value = '';
        document.getElementById('new-usecase-impact').value = '';
        document.getElementById('new-usecase-90day').value = '';
        document.getElementById('calc-users').value = '10';
        document.getElementById('calc-minutes').value = '30';
        document.getElementById('calc-hourly-rate').value = '3000';
        document.getElementById('calc-workdays').value = '20';
        this.loadUsecases();
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiAddUsecase(usecaseData);
  },

  // ========================================
  // 90-Day Plan (Module 2 Part B)
  // ========================================

  // 90日計画の初期化
  init90DayPlan() {
    this.state.ninetyDayPlan = {
      phases: {
        ignite: { objective: '', milestones: [], successCriteria: '' },
        strengthen: { objective: '', milestones: [], successCriteria: '' },
        establish: { objective: '', milestones: [], successCriteria: '' }
      },
      roles: [],
      requiredData: [],
      risks: [],
      communication: { meetingFrequency: 'weekly', stakeholders: '', reporting: '' }
    };
  },

  // 90日計画のロード
  load90DayPlan() {
    if (!this.state.currentProjectId) return;

    // 選択されたユースケースから目標を取得
    if (this.state.selectedUsecases.length > 0) {
      const selected = this.state.usecases.filter(uc => this.state.selectedUsecases.includes(uc.usecaseId));
      if (selected.length > 0 && !this.state.ninetyDayPlan.phases.ignite.objective) {
        this.state.ninetyDayPlan.phases.ignite.objective = selected.map(s => s.ninetyDayGoal || s.goal).join('\n');
      }
    }

    // 成熟度レベルを読み込む
    this.loadMaturityLevel();

    // サーバーから既存データを取得
    google.script.run
      .withSuccessHandler((response) => {
        if (response.success && response.data) {
          this.loadNinetyDayPlanData(response.data);
        }
        this.render90DayPlanUI();
      })
      .withFailureHandler((error) => {
        console.error('Failed to load 90-day plan:', error);
        this.render90DayPlanUI();
      })
      .apiGetNinetyDayPlan(this.state.currentProjectId);
  },

  // 成熟度レベルの読み込み
  loadMaturityLevel() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (response.success && response.data) {
          this.state.maturityLevel = response.data.maturity;
          this.state.maturityTemplates = response.data.templates;
          this.renderMaturityUI();
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load maturity level:', error);
      })
      .apiGetMaturityLevel(this.state.currentProjectId);
  },

  // 成熟度UIの描画
  renderMaturityUI() {
    const maturity = this.state.maturityLevel;
    if (!maturity) return;

    // バッジの更新
    const badge = document.getElementById('maturity-badge');
    if (badge) {
      badge.textContent = maturity.label;
      badge.classList.remove('hidden', 'bg-amber-100', 'text-amber-700', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700');

      if (maturity.level === 'ignite') {
        badge.classList.add('bg-amber-100', 'text-amber-700');
      } else if (maturity.level === 'strengthen') {
        badge.classList.add('bg-blue-100', 'text-blue-700');
      } else {
        badge.classList.add('bg-green-100', 'text-green-700');
      }
    }

    // 説明の更新
    const desc = document.getElementById('maturity-description');
    if (desc) {
      desc.textContent = maturity.description;
    }

    // スコアの更新
    const scoreEl = document.getElementById('maturity-score');
    if (scoreEl) {
      scoreEl.classList.remove('hidden');
      scoreEl.querySelector('span').textContent = maturity.averageScore;
    }

    // ドロップダウンを推奨値に設定
    const select = document.getElementById('maturity-template-select');
    if (select && maturity.level) {
      select.value = maturity.level;
      this.onMaturityTemplateChange();
    }
  },

  // テンプレート選択変更時
  onMaturityTemplateChange() {
    const select = document.getElementById('maturity-template-select');
    const selectedLevel = select ? select.value : '';
    const preview = document.getElementById('template-preview');

    if (!selectedLevel) {
      if (preview) preview.classList.add('hidden');
      return;
    }

    // テンプレートを取得してプレビュー表示
    google.script.run
      .withSuccessHandler((response) => {
        if (response.success && response.data) {
          this.showTemplatePreview(response.data);
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to get templates:', error);
      })
      .apiGet90DayPlanTemplates(selectedLevel);
  },

  // テンプレートプレビューの表示
  showTemplatePreview(templates) {
    const preview = document.getElementById('template-preview');
    if (!preview || !templates.phases) return;

    preview.classList.remove('hidden');

    const igniteEl = document.getElementById('preview-ignite');
    if (igniteEl) igniteEl.textContent = templates.phases.ignite?.objective || '--';

    const strengthenEl = document.getElementById('preview-strengthen');
    if (strengthenEl) strengthenEl.textContent = templates.phases.strengthen?.objective || '--';

    const establishEl = document.getElementById('preview-establish');
    if (establishEl) establishEl.textContent = templates.phases.establish?.objective || '--';
  },

  // テンプレート適用
  applyMaturityTemplate() {
    const select = document.getElementById('maturity-template-select');
    const selectedLevel = select ? select.value : '';

    if (!selectedLevel) {
      this.showToast('テンプレートを選択してください', 'warning');
      return;
    }

    if (!confirm(`${this.getMaturityLabel(selectedLevel)}のテンプレートを適用します。現在の90日計画の内容は上書きされます。よろしいですか？`)) {
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (response.success) {
          this.showToast(response.message, 'success');
          // 90日計画を再読み込み
          this.init90DayPlan();
          google.script.run
            .withSuccessHandler((planResponse) => {
              if (planResponse.success && planResponse.data) {
                this.loadNinetyDayPlanData(planResponse.data);
              }
              this.render90DayPlanUI();
            })
            .apiGetNinetyDayPlan(this.state.currentProjectId);
        } else {
          this.showToast(response.error || 'テンプレート適用に失敗しました', 'error');
        }
      })
      .withFailureHandler((error) => {
        this.showToast('テンプレート適用に失敗しました: ' + error.message, 'error');
      })
      .apiApplyMaturityTemplate(this.state.currentProjectId, selectedLevel);
  },

  // 成熟度ラベル取得
  getMaturityLabel(level) {
    const labels = {
      ignite: '始動段階',
      strengthen: '強化段階',
      master: '凌駕段階'
    };
    return labels[level] || level;
  },

  // サーバーデータを状態に反映
  loadNinetyDayPlanData(data) {
    if (!data) return;

    // フェーズデータのパース
    if (data.weeklyMilestones) {
      try {
        const parsed = typeof data.weeklyMilestones === 'string'
          ? JSON.parse(data.weeklyMilestones)
          : data.weeklyMilestones;
        if (parsed.phases) {
          this.state.ninetyDayPlan.phases = parsed.phases;
        }
      } catch (e) {
        console.warn('Failed to parse phases:', e);
      }
    }

    // 体制データのパース
    if (data.teamStructure) {
      try {
        const parsed = typeof data.teamStructure === 'string'
          ? JSON.parse(data.teamStructure)
          : data.teamStructure;
        if (parsed.roles) {
          this.state.ninetyDayPlan.roles = parsed.roles;
        }
      } catch (e) {
        console.warn('Failed to parse team structure:', e);
      }
    }

    // 必要データのパース
    if (data.requiredData) {
      try {
        const parsed = typeof data.requiredData === 'string'
          ? JSON.parse(data.requiredData)
          : data.requiredData;
        if (parsed.items) {
          this.state.ninetyDayPlan.requiredData = parsed.items;
        }
      } catch (e) {
        console.warn('Failed to parse required data:', e);
      }
    }

    // リスクデータのパース
    if (data.risks) {
      try {
        const parsed = typeof data.risks === 'string'
          ? JSON.parse(data.risks)
          : data.risks;
        if (parsed.items) {
          this.state.ninetyDayPlan.risks = parsed.items;
        }
      } catch (e) {
        console.warn('Failed to parse risks:', e);
      }
    }

    // コミュニケーション計画のパース
    if (data.communicationPlan) {
      try {
        const parsed = typeof data.communicationPlan === 'string'
          ? JSON.parse(data.communicationPlan)
          : data.communicationPlan;
        this.state.ninetyDayPlan.communication = parsed;
      } catch (e) {
        console.warn('Failed to parse communication plan:', e);
      }
    }
  },

  // 90日計画のUI描画
  render90DayPlanUI() {
    this.renderPhases();
    this.renderRoles();
    this.renderDataRequirements();
    this.renderRisks();
    this.renderCommunication();
  },

  // フェーズの描画
  renderPhases() {
    const phases = ['ignite', 'strengthen', 'establish'];
    phases.forEach(phaseId => {
      const phase = this.state.ninetyDayPlan.phases[phaseId];

      // 目標
      const objectiveEl = document.getElementById(`phase-${phaseId}-objective`);
      if (objectiveEl) objectiveEl.value = phase.objective || '';

      // 成功基準
      const criteriaEl = document.getElementById(`phase-${phaseId}-criteria`);
      if (criteriaEl) criteriaEl.value = phase.successCriteria || '';

      // マイルストーン
      this.renderPhaseMilestones(phaseId);

      // 進捗率
      this.updatePhaseProgress(phaseId);
    });
  },

  // フェーズのマイルストーン描画
  renderPhaseMilestones(phaseId) {
    const container = document.getElementById(`phase-${phaseId}-milestones`);
    if (!container) return;

    const milestones = this.state.ninetyDayPlan.phases[phaseId].milestones || [];

    if (milestones.length === 0) {
      container.innerHTML = `<p class="text-xs text-slate-400 italic py-2">マイルストーンを追加してください</p>`;
      return;
    }

    container.innerHTML = milestones.map((ms, idx) => `
      <div class="flex items-center gap-2">
        <input type="text" value="${this.escapeHtml(ms)}"
          onchange="App.updateMilestone('${phaseId}', ${idx}, this.value)"
          class="flex-1 px-3 py-2 text-sm rounded-md border border-slate-200 focus:ring-2 focus:ring-primary focus:border-transparent"
          placeholder="マイルストーン内容"/>
        <button onclick="App.removeMilestone('${phaseId}', ${idx})" class="p-1 text-slate-400 hover:text-red-500">
          <span class="material-symbols-outlined text-[16px]">close</span>
        </button>
      </div>
    `).join('');
  },

  // マイルストーン追加
  addMilestone(phaseId) {
    if (!this.state.ninetyDayPlan.phases[phaseId]) return;
    this.state.ninetyDayPlan.phases[phaseId].milestones.push('');
    this.renderPhaseMilestones(phaseId);
    this.updatePhaseProgress(phaseId);
  },

  // マイルストーン更新
  updateMilestone(phaseId, index, value) {
    if (!this.state.ninetyDayPlan.phases[phaseId]) return;
    this.state.ninetyDayPlan.phases[phaseId].milestones[index] = value;
    this.updatePhaseProgress(phaseId);
  },

  // マイルストーン削除
  removeMilestone(phaseId, index) {
    if (!this.state.ninetyDayPlan.phases[phaseId]) return;
    this.state.ninetyDayPlan.phases[phaseId].milestones.splice(index, 1);
    this.renderPhaseMilestones(phaseId);
    this.updatePhaseProgress(phaseId);
  },

  // フェーズ進捗率の更新
  updatePhaseProgress(phaseId) {
    const phase = this.state.ninetyDayPlan.phases[phaseId];
    let total = 3; // 目標、成功基準、マイルストーン
    let filled = 0;

    if (phase.objective) filled++;
    if (phase.successCriteria) filled++;
    if (phase.milestones.filter(m => m).length > 0) filled++;

    const progress = Math.round((filled / total) * 100);
    const progressEl = document.getElementById(`phase-${phaseId}-progress`);
    if (progressEl) {
      progressEl.textContent = `${progress}%`;
    }
  },

  // 体制・役割の描画
  renderRoles() {
    const container = document.getElementById('plan-roles');
    if (!container) return;

    const roles = this.state.ninetyDayPlan.roles;

    if (roles.length === 0) {
      container.innerHTML = `<p class="text-sm text-slate-400 text-center py-4">「追加」ボタンで役割を追加してください</p>`;
      return;
    }

    container.innerHTML = roles.map((role, idx) => `
      <div class="p-3 bg-slate-50 rounded-md border border-slate-100">
        <div class="flex items-start justify-between mb-2">
          <select onchange="App.updateRole(${idx}, 'pillar', this.value)" class="text-xs font-bold px-2 py-1 rounded bg-white border border-slate-200">
            <option value="CoE" ${role.pillar === 'CoE' ? 'selected' : ''}>CoE</option>
            <option value="Biz" ${role.pillar === 'Biz' ? 'selected' : ''}>Biz</option>
            <option value="IT" ${role.pillar === 'IT' ? 'selected' : ''}>IT</option>
          </select>
          <button onclick="App.removeRole(${idx})" class="p-1 text-slate-400 hover:text-red-500">
            <span class="material-symbols-outlined text-[14px]">close</span>
          </button>
        </div>
        <input type="text" value="${this.escapeHtml(role.title || '')}"
          onchange="App.updateRole(${idx}, 'title', this.value)"
          class="w-full px-2 py-1 text-sm font-medium rounded border border-slate-200 mb-2"
          placeholder="役職名"/>
        <input type="text" value="${this.escapeHtml(role.name || '')}"
          onchange="App.updateRole(${idx}, 'name', this.value)"
          class="w-full px-2 py-1 text-sm rounded border border-slate-200"
          placeholder="担当者名"/>
      </div>
    `).join('');
  },

  // 役割追加
  addRole() {
    this.state.ninetyDayPlan.roles.push({
      pillar: 'CoE',
      title: '',
      name: ''
    });
    this.renderRoles();
  },

  // 役割更新
  updateRole(index, field, value) {
    if (this.state.ninetyDayPlan.roles[index]) {
      this.state.ninetyDayPlan.roles[index][field] = value;
    }
  },

  // 役割削除
  removeRole(index) {
    this.state.ninetyDayPlan.roles.splice(index, 1);
    this.renderRoles();
  },

  // 必要データの描画
  renderDataRequirements() {
    const container = document.getElementById('plan-data');
    if (!container) return;

    const items = this.state.ninetyDayPlan.requiredData;

    if (items.length === 0) {
      container.innerHTML = `<p class="text-sm text-slate-400 text-center py-4">「追加」ボタンでデータ項目を追加してください</p>`;
      return;
    }

    container.innerHTML = items.map((item, idx) => `
      <div class="p-3 bg-slate-50 rounded-md border border-slate-100">
        <div class="flex items-start justify-between mb-2">
          <select onchange="App.updateDataItem(${idx}, 'status', this.value)"
            class="text-xs font-bold px-2 py-1 rounded ${this.getDataStatusClass(item.status)}">
            <option value="not_ready" ${item.status === 'not_ready' ? 'selected' : ''}>未準備</option>
            <option value="partial" ${item.status === 'partial' ? 'selected' : ''}>一部</option>
            <option value="ready" ${item.status === 'ready' ? 'selected' : ''}>準備完了</option>
          </select>
          <button onclick="App.removeDataItem(${idx})" class="p-1 text-slate-400 hover:text-red-500">
            <span class="material-symbols-outlined text-[14px]">close</span>
          </button>
        </div>
        <input type="text" value="${this.escapeHtml(item.name || '')}"
          onchange="App.updateDataItem(${idx}, 'name', this.value)"
          class="w-full px-2 py-1 text-sm font-medium rounded border border-slate-200 mb-2"
          placeholder="データ名"/>
        <input type="text" value="${this.escapeHtml(item.source || '')}"
          onchange="App.updateDataItem(${idx}, 'source', this.value)"
          class="w-full px-2 py-1 text-sm rounded border border-slate-200"
          placeholder="データソース（例：CRM、ERP）"/>
      </div>
    `).join('');
  },

  // データ状況のスタイルクラス
  getDataStatusClass(status) {
    const classes = {
      'ready': 'bg-green-100 text-green-700 border-green-200',
      'partial': 'bg-amber-100 text-amber-700 border-amber-200',
      'not_ready': 'bg-red-100 text-red-700 border-red-200'
    };
    return classes[status] || classes['not_ready'];
  },

  // データ項目追加
  addDataItem() {
    this.state.ninetyDayPlan.requiredData.push({
      name: '',
      source: '',
      status: 'not_ready'
    });
    this.renderDataRequirements();
  },

  // データ項目更新
  updateDataItem(index, field, value) {
    if (this.state.ninetyDayPlan.requiredData[index]) {
      this.state.ninetyDayPlan.requiredData[index][field] = value;
      if (field === 'status') {
        this.renderDataRequirements();
      }
    }
  },

  // データ項目削除
  removeDataItem(index) {
    this.state.ninetyDayPlan.requiredData.splice(index, 1);
    this.renderDataRequirements();
  },

  // リスクの描画
  renderRisks() {
    const container = document.getElementById('risks-list');
    if (!container) return;

    const risks = this.state.ninetyDayPlan.risks;

    if (risks.length === 0) {
      container.innerHTML = `<p class="text-sm text-slate-400 text-center py-4">「追加」ボタンでリスクを追加してください</p>`;
      return;
    }

    container.innerHTML = risks.map((risk, idx) => `
      <div class="p-3 bg-red-50 rounded-md border border-red-100">
        <div class="flex items-start justify-between mb-2">
          <select onchange="App.updateRisk(${idx}, 'impact', this.value)"
            class="text-xs font-bold px-2 py-1 rounded ${this.getRiskImpactClass(risk.impact)}">
            <option value="low" ${risk.impact === 'low' ? 'selected' : ''}>低</option>
            <option value="medium" ${risk.impact === 'medium' ? 'selected' : ''}>中</option>
            <option value="high" ${risk.impact === 'high' ? 'selected' : ''}>高</option>
          </select>
          <button onclick="App.removeRisk(${idx})" class="p-1 text-slate-400 hover:text-red-500">
            <span class="material-symbols-outlined text-[14px]">close</span>
          </button>
        </div>
        <textarea onchange="App.updateRisk(${idx}, 'description', this.value)"
          class="w-full px-2 py-1 text-sm rounded border border-red-200 mb-2 min-h-[60px] resize-y"
          placeholder="リスクの内容">${this.escapeHtml(risk.description || '')}</textarea>
        <input type="text" value="${this.escapeHtml(risk.mitigation || '')}"
          onchange="App.updateRisk(${idx}, 'mitigation', this.value)"
          class="w-full px-2 py-1 text-sm rounded border border-red-200"
          placeholder="対策"/>
      </div>
    `).join('');
  },

  // リスク影響度のスタイルクラス
  getRiskImpactClass(impact) {
    const classes = {
      'high': 'bg-red-200 text-red-800 border-red-300',
      'medium': 'bg-amber-100 text-amber-700 border-amber-200',
      'low': 'bg-green-100 text-green-700 border-green-200'
    };
    return classes[impact] || classes['medium'];
  },

  // リスク追加（インライン）
  addRiskInline() {
    this.state.ninetyDayPlan.risks.push({
      description: '',
      impact: 'medium',
      mitigation: ''
    });
    this.renderRisks();
  },

  // リスク更新
  updateRisk(index, field, value) {
    if (this.state.ninetyDayPlan.risks[index]) {
      this.state.ninetyDayPlan.risks[index][field] = value;
      if (field === 'impact') {
        this.renderRisks();
      }
    }
  },

  // リスク削除
  removeRisk(index) {
    this.state.ninetyDayPlan.risks.splice(index, 1);
    this.renderRisks();
  },

  // コミュニケーション計画の描画
  renderCommunication() {
    const comm = this.state.ninetyDayPlan.communication;

    const meetingEl = document.getElementById('plan-meeting');
    if (meetingEl) meetingEl.value = comm.meetingFrequency || 'weekly';

    const stakeholdersEl = document.getElementById('plan-stakeholders');
    if (stakeholdersEl) stakeholdersEl.value = comm.stakeholders || '';

    const reportingEl = document.getElementById('plan-reporting');
    if (reportingEl) reportingEl.value = comm.reporting || '';
  },

  // 90日計画データの収集
  collect90DayPlanData() {
    // フェーズデータを収集
    const phases = {};
    ['ignite', 'strengthen', 'establish'].forEach(phaseId => {
      phases[phaseId] = {
        objective: document.getElementById(`phase-${phaseId}-objective`)?.value || '',
        milestones: this.state.ninetyDayPlan.phases[phaseId].milestones.filter(m => m),
        successCriteria: document.getElementById(`phase-${phaseId}-criteria`)?.value || ''
      };
    });

    // コミュニケーション計画を収集
    const communication = {
      meetingFrequency: document.getElementById('plan-meeting')?.value || 'weekly',
      stakeholders: document.getElementById('plan-stakeholders')?.value || '',
      reporting: document.getElementById('plan-reporting')?.value || ''
    };

    return {
      projectId: this.state.currentProjectId,
      usecaseId: this.state.selectedUsecases[0] || null,
      teamStructure: JSON.stringify({ roles: this.state.ninetyDayPlan.roles }),
      requiredData: JSON.stringify({ items: this.state.ninetyDayPlan.requiredData }),
      risks: JSON.stringify({ items: this.state.ninetyDayPlan.risks }),
      communicationPlan: JSON.stringify(communication),
      weeklyMilestones: JSON.stringify({ phases: phases })
    };
  },

  // 90日計画の保存
  save90DayPlan() {
    if (!this.state.currentProjectId) {
      this.showError('プロジェクトが選択されていません');
      return;
    }

    const planData = this.collect90DayPlanData();

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }
        this.showSaveStatus();
        this.showSuccess('90日計画を保存しました');
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveNinetyDayPlan(planData);
  },

  // ========================================
  // RACI (Module 4)
  // ========================================
  loadRACIEntries() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        this.state.raciEntries = response.data || [];
        this.renderRACITable();
        this.renderPillarCards();
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetRACIEntries(this.state.currentProjectId);
  },

  renderRACITable() {
    const tbody = document.getElementById('raci-table-body');
    if (!tbody) return;

    if (this.state.raciEntries.length === 0) {
      // Add default empty row
      this.state.raciEntries = [{ pillar: 'CoE', task: '', assignee: '', raci: 'R' }];
    }

    tbody.innerHTML = this.state.raciEntries.map((entry, idx) => `
      <tr class="hover:bg-slate-50 transition-colors">
        <td class="p-4">
          <select data-idx="${idx}" data-field="pillar" onchange="App.updateRACIEntry(this)" class="w-full px-3 py-2 rounded-md border border-slate-300 bg-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="CoE" ${entry.pillar === 'CoE' ? 'selected' : ''}>CoE</option>
            <option value="Biz Data Network" ${entry.pillar === 'Biz Data Network' ? 'selected' : ''}>Biz Data Network</option>
            <option value="IT" ${entry.pillar === 'IT' ? 'selected' : ''}>IT</option>
          </select>
        </td>
        <td class="p-4">
          <input type="text" data-idx="${idx}" data-field="task" onchange="App.updateRACIEntry(this)" value="${this.escapeHtml(entry.task)}" class="w-full px-3 py-2 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="タスク名"/>
        </td>
        <td class="p-4">
          <input type="text" data-idx="${idx}" data-field="assignee" onchange="App.updateRACIEntry(this)" value="${this.escapeHtml(entry.assignee)}" class="w-full px-3 py-2 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="担当者"/>
        </td>
        <td class="p-4 text-center">
          <select data-idx="${idx}" data-field="raci" onchange="App.updateRACIEntry(this)" class="px-3 py-2 rounded-md border border-slate-300 bg-white text-sm font-bold focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="R" ${entry.raci === 'R' ? 'selected' : ''}>R</option>
            <option value="A" ${entry.raci === 'A' ? 'selected' : ''}>A</option>
            <option value="C" ${entry.raci === 'C' ? 'selected' : ''}>C</option>
            <option value="I" ${entry.raci === 'I' ? 'selected' : ''}>I</option>
          </select>
        </td>
        <td class="p-4 text-center">
          <button onclick="App.removeRACIRow(${idx})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors">
            <span class="material-symbols-outlined text-[18px]">delete</span>
          </button>
        </td>
      </tr>
    `).join('');
  },

  renderPillarCards() {
    const pillars = {
      'CoE': 'pillar-coe',
      'Biz Data Network': 'pillar-biz',
      'IT': 'pillar-it'
    };

    Object.entries(pillars).forEach(([pillar, containerId]) => {
      const container = document.getElementById(containerId);
      if (!container) return;

      const entries = this.state.raciEntries.filter(e => e.pillar === pillar && e.task);

      if (entries.length === 0) {
        container.innerHTML = `<p class="text-sm text-slate-400 italic">タスク未割り当て</p>`;
        return;
      }

      container.innerHTML = entries.map(e => `
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-md border border-slate-100">
          <div class="flex items-center gap-2">
            <span class="size-7 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs font-bold text-slate-600">${e.assignee?.charAt(0)?.toUpperCase() || '?'}</span>
            <div>
              <p class="text-sm font-medium text-slate-800">${this.escapeHtml(e.task)}</p>
              <p class="text-xs text-slate-500">${this.escapeHtml(e.assignee)}</p>
            </div>
          </div>
          <span class="px-2 py-0.5 rounded text-[10px] font-bold ${this.getRACIBadgeClass(e.raci)}">${e.raci}</span>
        </div>
      `).join('');
    });
  },

  getRACIBadgeClass(raci) {
    const classes = {
      'R': 'bg-blue-50 text-blue-700 border border-blue-100',
      'A': 'bg-red-50 text-red-700 border border-red-100',
      'C': 'bg-amber-50 text-amber-700 border border-amber-100',
      'I': 'bg-slate-100 text-slate-600 border border-slate-200'
    };
    return classes[raci] || classes['R'];
  },

  updateRACIEntry(el) {
    const idx = parseInt(el.dataset.idx);
    const field = el.dataset.field;
    this.state.raciEntries[idx][field] = el.value;
    this.renderPillarCards();
  },

  addRACIRow() {
    this.state.raciEntries.push({ pillar: 'CoE', task: '', assignee: '', raci: 'R' });
    this.renderRACITable();
  },

  removeRACIRow(idx) {
    this.state.raciEntries.splice(idx, 1);
    if (this.state.raciEntries.length === 0) {
      this.state.raciEntries.push({ pillar: 'CoE', task: '', assignee: '', raci: 'R' });
    }
    this.renderRACITable();
    this.renderPillarCards();
  },

  saveRACIEntries() {
    if (!this.state.currentProjectId) return;

    const entries = this.state.raciEntries.filter(e => e.task && e.assignee);

    if (entries.length === 0) {
            alert('担当者付きのタスクを1件以上追加してください');
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

        this.showSaveStatus();
        this.loadRACIEntries();
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveRACIEntries(this.state.currentProjectId, entries);
  },

  // ========================================
  // Value Tracker (Module 7)
  // ========================================
  loadValues() {
    if (!this.state.currentProjectId) return;

    // First load usecases
    google.script.run
      .withSuccessHandler((response) => {
        if (response.success) {
          this.state.usecases = response.data || [];
          this.loadValuesData();
        }
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetUsecases(this.state.currentProjectId);

    // Update project name in breadcrumb
    if (this.state.currentProject) {
      const el = document.getElementById('value-project-name');
      if (el) el.textContent = this.state.currentProject.customerName;
    }
  },

  loadValuesData() {
    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        this.state.values = response.data || [];
        this.renderValueCards();
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetValues(this.state.currentProjectId);
  },

  renderValueCards() {
    const container = document.getElementById('value-cards');
    if (!container) return;

    if (this.state.usecases.length === 0) {
      container.innerHTML = `
        <div class="col-span-full text-center py-12 bg-white rounded-lg border border-slate-200">
          <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">assignment</span>
                    <p class="text-slate-500">追跡するユースケースがありません。まずモジュール2でユースケースを作成してください。</p>
        </div>
      `;
      return;
    }

    container.innerHTML = this.state.usecases.map(uc => {
      const value = this.state.values.find(v => v.usecaseId === uc.usecaseId) || {};

      return `
        <div class="bg-white rounded-lg border border-slate-200 shadow-card overflow-hidden">
          <div class="p-5 border-b border-slate-100 bg-slate-50">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="font-bold text-slate-800 mb-1">${this.escapeHtml(uc.goal)}</h3>
                <p class="text-xs text-slate-500">${this.escapeHtml(uc.challenge)}</p>
              </div>
              <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-primary-light text-primary border border-primary/20">Active</span>
            </div>
          </div>
          <div class="p-5 space-y-4">
            <div>
                            <label class="label-base">定量効果</label>
              <textarea id="quant-${uc.usecaseId}" class="input-base min-h-[60px]" placeholder="例：コスト30%削減、1日2時間削減">${this.escapeHtml(value.quantitativeImpact || '')}</textarea>
            </div>
            <div>
              <label class="label-base">定性効果</label>
              <textarea id="qual-${uc.usecaseId}" class="input-base min-h-[60px]" placeholder="例：チームの士気向上、意思決定の迅速化">${this.escapeHtml(value.qualitativeImpact || '')}</textarea>
            </div>
            <div>
              <label class="label-base">証跡（Driveリンク）</label>
              <input id="evidence-${uc.usecaseId}" type="text" class="input-base" value="${this.escapeHtml(value.evidence || '')}" placeholder="https://drive.google.com/..."/>
            </div>
            <div>
              <label class="label-base">投資判断</label>
              <select id="invest-${uc.usecaseId}" class="input-base">
                                <option value="" ${!value.nextInvestment ? 'selected' : ''}>選択...</option>
                <option value="Continue" ${value.nextInvestment === 'Continue' ? 'selected' : ''}>継続</option>
                <option value="Expand" ${value.nextInvestment === 'Expand' ? 'selected' : ''}>拡大</option>
                <option value="Reduce" ${value.nextInvestment === 'Reduce' ? 'selected' : ''}>縮小</option>
              </select>
            </div>
          </div>
          <div class="px-5 py-3 bg-slate-50 border-t border-slate-100">
                        <button onclick="App.saveValue('${uc.usecaseId}')" class="w-full btn-primary text-sm">
              変更を保存
            </button>
          </div>
        </div>
      `;
    }).join('');
  },

  saveValue(usecaseId) {
    if (!this.state.currentProjectId) return;

    const valueData = {
      projectId: this.state.currentProjectId,
      usecaseId: usecaseId,
      quantitativeImpact: document.getElementById('quant-' + usecaseId)?.value.trim() || '',
      qualitativeImpact: document.getElementById('qual-' + usecaseId)?.value.trim() || '',
      evidence: document.getElementById('evidence-' + usecaseId)?.value.trim() || '',
      nextInvestment: document.getElementById('invest-' + usecaseId)?.value || ''
    };

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

                this.showSuccess('価値追跡を保存しました');
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveValue(valueData);
  },

  // ========================================
  // Core Process (Module 3)
  // ========================================
  loadCoreProcess() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        const data = response.data;
        if (data) {
          document.getElementById('agility-score').value = data.agilityScore || 3;
          document.getElementById('skills-score').value = data.skillsScore || 3;
          document.getElementById('dataQuality-score').value = data.dataQualityScore || 3;
          document.getElementById('trust-score').value = data.trustScore || 3;
          document.getElementById('operationalEfficiency-score').value = data.operationalEfficiencyScore || 3;
          document.getElementById('community-score').value = data.communityScore || 3;

          document.getElementById('agility-comment').value = data.agilityComment || '';
          document.getElementById('skills-comment').value = data.skillsComment || '';
          document.getElementById('dataQuality-comment').value = data.dataQualityComment || '';
          document.getElementById('trust-comment').value = data.trustComment || '';
          document.getElementById('operationalEfficiency-comment').value = data.operationalEfficiencyComment || '';
          document.getElementById('community-comment').value = data.communityComment || '';

          // Update score displays
          ['agility', 'skills', 'dataQuality', 'trust', 'operationalEfficiency', 'community'].forEach(key => {
            this.updateScoreDisplay(key);
          });

          this.generateRoadmap(data);
        }
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetCoreProcess(this.state.currentProjectId);
  },

  updateScoreDisplay(key) {
    const score = document.getElementById(key + '-score')?.value || 3;
    const display = document.getElementById(key + '-score-display');
    if (display) {
      display.textContent = score;
    }
  },

  saveCoreProcess() {
    if (!this.state.currentProjectId) return;

    const processData = {
      projectId: this.state.currentProjectId,
      agilityScore: parseInt(document.getElementById('agility-score')?.value) || 3,
      skillsScore: parseInt(document.getElementById('skills-score')?.value) || 3,
      dataQualityScore: parseInt(document.getElementById('dataQuality-score')?.value) || 3,
      trustScore: parseInt(document.getElementById('trust-score')?.value) || 3,
      operationalEfficiencyScore: parseInt(document.getElementById('operationalEfficiency-score')?.value) || 3,
      communityScore: parseInt(document.getElementById('community-score')?.value) || 3,
      agilityComment: document.getElementById('agility-comment')?.value.trim() || '',
      skillsComment: document.getElementById('skills-comment')?.value.trim() || '',
      dataQualityComment: document.getElementById('dataQuality-comment')?.value.trim() || '',
      trustComment: document.getElementById('trust-comment')?.value.trim() || '',
      operationalEfficiencyComment: document.getElementById('operationalEfficiency-comment')?.value.trim() || '',
      communityComment: document.getElementById('community-comment')?.value.trim() || ''
    };

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

                this.showSuccess('コアプロセス評価を保存しました');
        this.generateRoadmap(processData);
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveCoreProcess(processData);
  },

  generateRoadmap(data) {
    const container = document.getElementById('roadmap-output');
    if (!container) return;

    const scores = [
      { name: 'Agility', score: data.agilityScore || 3, icon: 'bolt', color: 'blue' },
      { name: 'Skills', score: data.skillsScore || 3, icon: 'school', color: 'green' },
      { name: 'Data Quality', score: data.dataQualityScore || 3, icon: 'database', color: 'purple' },
      { name: 'Trust', score: data.trustScore || 3, icon: 'verified_user', color: 'amber' },
      { name: 'Operational Efficiency', score: data.operationalEfficiencyScore || 3, icon: 'speed', color: 'red' },
      { name: 'Community', score: data.communityScore || 3, icon: 'groups', color: 'teal' }
    ];

    const sorted = [...scores].sort((a, b) => a.score - b.score);
    const phases = {
      ignite: sorted.filter(s => s.score <= 2),
      strengthen: sorted.filter(s => s.score === 3),
      transcend: sorted.filter(s => s.score >= 4)
    };

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-amber-600 text-[20px]">rocket_launch</span>
                        <h4 class="font-bold text-amber-800">始動（優先）</h4>
          </div>
          <div class="space-y-2">
            ${phases.ignite.length ? phases.ignite.map(s => `
              <div class="flex items-center gap-2 text-sm text-amber-700">
                <span class="material-symbols-outlined text-[16px]">${s.icon}</span>
                <span>${s.name} (Score: ${s.score})</span>
              </div>
            `).join('') : '<p class="text-sm text-amber-600 italic">No immediate priorities</p>'}
          </div>
        </div>
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-blue-600 text-[20px]">trending_up</span>
                        <h4 class="font-bold text-blue-800">強化</h4>
          </div>
          <div class="space-y-2">
            ${phases.strengthen.length ? phases.strengthen.map(s => `
              <div class="flex items-center gap-2 text-sm text-blue-700">
                <span class="material-symbols-outlined text-[16px]">${s.icon}</span>
                <span>${s.name} (Score: ${s.score})</span>
              </div>
            `).join('') : '<p class="text-sm text-blue-600 italic">No items in this phase</p>'}
          </div>
        </div>
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="material-symbols-outlined text-green-600 text-[20px]">stars</span>
                        <h4 class="font-bold text-green-800">凌駕</h4>
          </div>
          <div class="space-y-2">
            ${phases.transcend.length ? phases.transcend.map(s => `
              <div class="flex items-center gap-2 text-sm text-green-700">
                <span class="material-symbols-outlined text-[16px]">${s.icon}</span>
                <span>${s.name} (Score: ${s.score})</span>
              </div>
            `).join('') : '<p class="text-sm text-green-600 italic">No items in this phase</p>'}
          </div>
        </div>
      </div>
    `;
  },

  // ========================================
  // Governance (Module 5)
  // ========================================
  loadGovernance() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        this.state.governanceEntries = response.data || [];
        this.renderGovernanceTable();
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetGovernanceEntries(this.state.currentProjectId);
  },

  renderGovernanceTable() {
    const tbody = document.getElementById('governance-table-body');
    if (!tbody) return;

    if (!this.state.governanceEntries) {
      this.state.governanceEntries = [];
    }

    if (this.state.governanceEntries.length === 0) {
      this.state.governanceEntries = [{ target: '', model: '', owner: '', rules: '', exceptionProcess: '' }];
    }

    tbody.innerHTML = this.state.governanceEntries.map((entry, idx) => `
      <tr class="hover:bg-slate-50 transition-colors">
        <td class="p-4">
          <input type="text" data-idx="${idx}" data-field="target" onchange="App.updateGovernanceEntry(this)" value="${this.escapeHtml(entry.target)}" class="w-full px-3 py-2 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g. Sales Data"/>
        </td>
        <td class="p-4">
          <select data-idx="${idx}" data-field="model" onchange="App.updateGovernanceEntry(this)" class="w-full px-3 py-2 rounded-md border border-slate-300 bg-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="" ${!entry.model ? 'selected' : ''}>Select...</option>
            <option value="Centralized" ${entry.model === 'Centralized' ? 'selected' : ''}>Centralized</option>
            <option value="Federated" ${entry.model === 'Federated' ? 'selected' : ''}>Federated</option>
            <option value="Hybrid" ${entry.model === 'Hybrid' ? 'selected' : ''}>Hybrid</option>
          </select>
        </td>
        <td class="p-4">
          <input type="text" data-idx="${idx}" data-field="owner" onchange="App.updateGovernanceEntry(this)" value="${this.escapeHtml(entry.owner)}" class="w-full px-3 py-2 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Owner name"/>
        </td>
        <td class="p-4">
          <input type="text" data-idx="${idx}" data-field="rules" onchange="App.updateGovernanceEntry(this)" value="${this.escapeHtml(entry.rules)}" class="w-full px-3 py-2 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Governance rules"/>
        </td>
        <td class="p-4">
          <input type="text" data-idx="${idx}" data-field="exceptionProcess" onchange="App.updateGovernanceEntry(this)" value="${this.escapeHtml(entry.exceptionProcess)}" class="w-full px-3 py-2 rounded-md border border-slate-300 text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Exception handling"/>
        </td>
        <td class="p-4 text-center">
          <button onclick="App.removeGovernanceRow(${idx})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors">
            <span class="material-symbols-outlined text-[18px]">delete</span>
          </button>
        </td>
      </tr>
    `).join('');
  },

  updateGovernanceEntry(el) {
    const idx = parseInt(el.dataset.idx);
    const field = el.dataset.field;
    if (!this.state.governanceEntries) {
      this.state.governanceEntries = [];
    }
    if (!this.state.governanceEntries[idx]) {
      this.state.governanceEntries[idx] = {};
    }
    this.state.governanceEntries[idx][field] = el.value;
  },

  addGovernanceRow() {
    if (!this.state.governanceEntries) {
      this.state.governanceEntries = [];
    }
    this.state.governanceEntries.push({ target: '', model: '', owner: '', rules: '', exceptionProcess: '' });
    this.renderGovernanceTable();
  },

  removeGovernanceRow(idx) {
    if (!this.state.governanceEntries) return;
    this.state.governanceEntries.splice(idx, 1);
    if (this.state.governanceEntries.length === 0) {
      this.state.governanceEntries.push({ target: '', model: '', owner: '', rules: '', exceptionProcess: '' });
    }
    this.renderGovernanceTable();
  },

  saveGovernanceEntries() {
    if (!this.state.currentProjectId) return;

    const entries = (this.state.governanceEntries || []).filter(e => e.target || e.owner);

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

                this.showSuccess('統制エントリを保存しました');
        this.loadGovernance();
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveGovernanceEntries(this.state.currentProjectId, entries);
  },

  // ========================================
  // Operations Support (Module 6)
  // ========================================
  loadOperationsSupport() {
    if (!this.state.currentProjectId) return;

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) return;

        const data = response.data;
        if (data) {
          document.getElementById('l1-support').value = data.l1Support || '';
          document.getElementById('l2-support').value = data.l2Support || '';
          document.getElementById('l3-support').value = data.l3Support || '';
          document.getElementById('l4-support').value = data.l4Support || '';
          document.getElementById('faq-link').value = data.faqLink || '';
          document.getElementById('escalation-criteria').value = data.escalationCriteria || '';
          document.getElementById('community-ops').value = data.communityOps || '';
        }
      })
      .withFailureHandler((error) => console.error(error))
      .apiGetOperationsSupport(this.state.currentProjectId);
  },

  saveOperationsSupport() {
    if (!this.state.currentProjectId) return;

    const supportData = {
      projectId: this.state.currentProjectId,
      l1Support: document.getElementById('l1-support')?.value.trim() || '',
      l2Support: document.getElementById('l2-support')?.value.trim() || '',
      l3Support: document.getElementById('l3-support')?.value.trim() || '',
      l4Support: document.getElementById('l4-support')?.value.trim() || '',
      faqLink: document.getElementById('faq-link')?.value.trim() || '',
      escalationCriteria: document.getElementById('escalation-criteria')?.value.trim() || '',
      communityOps: document.getElementById('community-ops')?.value.trim() || ''
    };

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

                this.showSuccess('運営支援を保存しました');
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiSaveOperationsSupport(supportData);
  },

  // ========================================
  // Document Generation
  // ========================================
  generateProposal() {
    if (!this.state.currentProjectId) return;

        if (!confirm('稟議書を生成しますか？少し時間がかかる場合があります。')) {
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }

                this.showSuccess('稟議書を生成しました！');
        if (response.data?.documentUrl) {
          window.open(response.data.documentUrl, '_blank');
        }
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiGenerateProposal(this.state.currentProjectId);
  },

  // ========================================
  // Utilities
  // ========================================
  escapeHtml(text) {
    if (!text) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
  },

  formatDate(date) {
    if (!date) return '-';
    const d = new Date(date);
    return d.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
  },

  showError(message) {
        alert('エラー: ' + message);
  },

  showSuccess(message) {
    // Simple alert for now, can be enhanced with toast notifications
    console.log('Success:', message);
  },

  showSaveStatus() {
    const status = document.getElementById('save-status');
    if (status) {
      status.classList.remove('hidden');
      status.classList.add('flex');
      setTimeout(() => {
        status.classList.add('hidden');
        status.classList.remove('flex');
      }, 3000);
    }
  },

  // ========================================
  // Demo Data Management
  // ========================================

  generateDemoData() {
    if (!this.state.currentProjectId) {
      this.showError('プロジェクトを先に選択してください');
      return;
    }

    if (!confirm('このプロジェクトにデモデータを生成しますか？\n既存のデータがある場合は上書きされます。')) {
      return;
    }

    this.showToast('デモデータを生成中...', 'info');

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }
        this.showToast('デモデータを生成しました！各モジュールを確認してください。', 'success');
        // Reload current view to show the demo data
        this.navigate(this.state.currentView);
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiGenerateDemoData(this.state.currentProjectId);
  },

  clearProjectData() {
    if (!this.state.currentProjectId) {
      this.showError('プロジェクトを先に選択してください');
      return;
    }

    if (!confirm('⚠️ 本当にこのプロジェクトの全データを削除しますか？\n\nこの操作は取り消せません。ビジョン、ユースケース、90日計画、RACI、価値トラッキングなど、すべてのデータが削除されます。')) {
      return;
    }

    // Double confirmation for safety
    if (!confirm('最終確認：削除を実行しますか？')) {
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        if (!response.success) {
          this.showError(response.error);
          return;
        }
        this.showToast('プロジェクトデータをクリアしました', 'success');
        // Reload current view
        this.navigate(this.state.currentView);
      })
      .withFailureHandler((error) => this.showError(error.message))
      .apiClearProjectData(this.state.currentProjectId);
  },

  // ========================================
  // Toast Notification System
  // ========================================

  showToast(message, type = 'info') {
    // Remove existing toast if any
    const existingToast = document.getElementById('toast-notification');
    if (existingToast) {
      existingToast.remove();
    }

    const icons = {
      success: 'check_circle',
      error: 'error',
      warning: 'warning',
      info: 'info'
    };

    const colors = {
      success: 'bg-emerald-50 border-emerald-200 text-emerald-800',
      error: 'bg-red-50 border-red-200 text-red-800',
      warning: 'bg-amber-50 border-amber-200 text-amber-800',
      info: 'bg-blue-50 border-blue-200 text-blue-800'
    };

    const iconColors = {
      success: 'text-emerald-500',
      error: 'text-red-500',
      warning: 'text-amber-500',
      info: 'text-blue-500'
    };

    const toast = document.createElement('div');
    toast.id = 'toast-notification';
    toast.className = `fixed bottom-6 right-6 z-50 flex items-center gap-3 px-4 py-3 rounded-lg border shadow-lg ${colors[type]} animate-slide-up`;
    toast.innerHTML = `
      <span class="material-symbols-outlined ${iconColors[type]}">${icons[type]}</span>
      <span class="text-sm font-medium">${this.escapeHtml(message)}</span>
      <button onclick="this.parentElement.remove()" class="ml-2 opacity-60 hover:opacity-100">
        <span class="material-symbols-outlined text-[18px]">close</span>
      </button>
    `;

    document.body.appendChild(toast);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentElement) {
        toast.classList.add('animate-fade-out');
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  },

  // ========================================
  // Usecase Scoring with Criteria
  // ========================================

  usecaseScores: {},

  updateUsecaseScore(usecaseId, type, value) {
    if (!this.usecaseScores[usecaseId]) {
      this.usecaseScores[usecaseId] = { impact: 3, feasibility: 3, capability: 3 };
    }
    this.usecaseScores[usecaseId][type] = parseInt(value);

    // Update the score display
    const displayEl = document.querySelector(`[data-score-display="${usecaseId}-${type}"]`);
    if (displayEl) {
      displayEl.textContent = value;
    }

    // Recalculate total score
    this.updateUsecaseTotalScore(usecaseId);
  },

  updateUsecaseTotalScore(usecaseId) {
    const scores = this.usecaseScores[usecaseId] || { impact: 3, feasibility: 3, capability: 3 };
    const total = (scores.impact * 0.4 + scores.feasibility * 0.3 + scores.capability * 0.3) * 20;

    const totalEl = document.querySelector(`[data-total-score="${usecaseId}"]`);
    if (totalEl) {
      totalEl.textContent = total.toFixed(0);
    }
  },

  showScoringGuide(type) {
    const guides = {
      impact: {
        title: 'インパクト評価基準',
        criteria: [
          { score: 5, label: '非常に高い', desc: '売上/利益に直結、経営会議で話題になるレベル' },
          { score: 4, label: '高い', desc: '部門KPIに直結、数千万円規模の効果' },
          { score: 3, label: '中程度', desc: '業務効率化に貢献、数百万円規模の効果' },
          { score: 2, label: '低い', desc: 'あれば便利、定性的な効果が主' },
          { score: 1, label: '限定的', desc: '検証目的、直接的な効果は限定的' }
        ]
      },
      feasibility: {
        title: '実現可能性評価基準',
        criteria: [
          { score: 5, label: '即実行可能', desc: 'データあり・ツールあり・スキルあり' },
          { score: 4, label: '容易', desc: '1つ不足だが容易に調達可能' },
          { score: 3, label: '標準', desc: '準備が必要だが90日で実現可能' },
          { score: 2, label: '困難', desc: '大きな投資（人・金・時間）が必要' },
          { score: 1, label: '非常に困難', desc: '現時点では技術的/組織的に困難' }
        ]
      },
      capability: {
        title: '能力向上評価基準',
        criteria: [
          { score: 5, label: '戦略的', desc: '組織全体のデータ活用能力が飛躍的に向上' },
          { score: 4, label: '高い学習効果', desc: '複数部門に展開可能なスキルを獲得' },
          { score: 3, label: '中程度', desc: 'チームレベルでのスキル向上' },
          { score: 2, label: '限定的', desc: '個人レベルでの学習にとどまる' },
          { score: 1, label: '最小', desc: '新規スキル獲得はほぼなし' }
        ]
      }
    };

    const guide = guides[type];
    if (!guide) return;

    const modal = document.createElement('div');
    modal.id = 'scoring-guide-modal';
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-5 border-b border-slate-200 bg-slate-50">
          <h3 class="text-lg font-bold text-slate-900">${guide.title}</h3>
          <button onclick="document.getElementById('scoring-guide-modal').remove()" class="text-slate-400 hover:text-slate-600">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="p-5 overflow-y-auto max-h-[60vh]">
          <div class="space-y-3">
            ${guide.criteria.map(c => `
              <div class="flex items-start gap-3 p-3 rounded-lg bg-slate-50 border border-slate-100">
                <span class="flex items-center justify-center size-8 rounded-full bg-primary text-white text-sm font-bold shrink-0">${c.score}</span>
                <div>
                  <p class="font-semibold text-slate-800">${c.label}</p>
                  <p class="text-sm text-slate-600">${c.desc}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-slate-50">
          <button onclick="document.getElementById('scoring-guide-modal').remove()" class="w-full btn-primary">
            閉じる
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },

  // ========================================
  // Module Progress Tracking
  // ========================================

  moduleStatus: {},

  updateModuleProgress() {
    if (!this.state.currentProjectId) return;

    const modules = ['vision', 'usecases', '90days', 'raci', 'value'];
    let completedCount = 0;

    // Check each module's completion status
    modules.forEach(mod => {
      const isComplete = this.checkModuleCompletion(mod);
      this.moduleStatus[mod] = isComplete;
      if (isComplete) completedCount++;
    });

    const progressPercent = Math.round((completedCount / modules.length) * 100);

    // Update progress bar
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-percent');

    if (progressBar) {
      progressBar.style.width = progressPercent + '%';
    }
    if (progressText) {
      progressText.innerHTML = `${progressPercent}% <span class="text-xs font-medium text-slate-500 ml-1 align-middle">完了</span>`;
    }

    // Update module cards with status
    this.renderModuleCards();
  },

  checkModuleCompletion(moduleName) {
    switch (moduleName) {
      case 'vision':
        return !!(this.state.currentProject && document.getElementById('vision-text')?.value?.trim());
      case 'usecases':
        return this.state.usecases && this.state.usecases.length > 0;
      case '90days':
        return !!(this.state.ninetyDayPlan?.phases?.ignite?.objective);
      case 'raci':
        return this.state.raciEntries && this.state.raciEntries.some(e => e.task && e.assignee);
      case 'value':
        return this.state.values && this.state.values.some(v => v.quantitativeImpact || v.qualitativeImpact);
      default:
        return false;
    }
  },

  getVisionSuccessMetrics() {
    const metricsEl = document.getElementById('vision-metrics');
    return metricsEl?.value || '';
  }
};

// Initialize on load
window.onload = () => App.init();

// Add CSS animation for toast
const style = document.createElement('style');
style.textContent = `
  @keyframes slide-up {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes fade-out {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  .animate-slide-up { animation: slide-up 0.3s ease-out; }
  .animate-fade-out { animation: fade-out 0.3s ease-out; }
`;
document.head.appendChild(style);
</script>






