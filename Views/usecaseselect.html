<!-- Use Case Selection View (Module 2) - Blueprint ワークショップ -->
<div class="flex flex-col lg:flex-row gap-6 h-full pb-24">

  <!-- Main Content -->
  <main class="flex-1 flex flex-col gap-5">
    <!-- Header Card -->
    <div class="flex flex-col gap-1 bg-white p-6 rounded-lg shadow-card border border-border-color">
      <div class="flex items-center gap-3 mb-1">
        <span class="px-2 py-0.5 rounded bg-blue-50 text-primary text-[11px] font-bold uppercase tracking-wide border border-blue-100">Step A</span>
        <h1 class="text-2xl font-bold text-slate-800 tracking-tight">ユースケース選定</h1>
      </div>
      <p class="text-slate-500 text-sm leading-relaxed max-w-3xl">
        候補のユースケースをスコアリングし、ビジネスインパクトと実現可能性に基づいて上位1〜2件を選定します。選定されたケースは自動的に90日計画ボードへ移行されます。
      </p>
    </div>

    <!-- Use Cases Table -->
    <div class="w-full bg-white rounded-lg shadow-card border border-border-color overflow-hidden">
      <div class="overflow-x-auto custom-scrollbar">
        <table class="w-full min-w-[900px]" id="usecase-table">
          <thead>
            <tr class="bg-slate-50 border-b border-slate-200">
              <th class="px-6 py-3 text-left text-[11px] font-bold text-slate-500 uppercase tracking-wider w-[28%]">
                候補ユースケース
              </th>
              <th class="px-4 py-3 text-left w-[15%]">
                <div class="flex flex-col">
                  <span class="text-xs font-bold text-slate-700">インパクト</span>
                  <span class="text-[10px] text-slate-400 font-normal">Impact (1-5)</span>
                </div>
              </th>
              <th class="px-4 py-3 text-left w-[15%]">
                <div class="flex flex-col">
                  <span class="text-xs font-bold text-slate-700">実現性(90日)</span>
                  <span class="text-[10px] text-slate-400 font-normal">Feasibility (1-5)</span>
                </div>
              </th>
              <th class="px-4 py-3 text-left w-[15%]">
                <div class="flex flex-col">
                  <span class="text-xs font-bold text-slate-700">能力構築</span>
                  <span class="text-[10px] text-slate-400 font-normal">Capability (1-5)</span>
                </div>
              </th>
              <th class="px-4 py-3 text-center text-[11px] font-bold text-slate-500 uppercase tracking-wider w-[10%] border-l border-slate-100">
                合計
              </th>
              <th class="px-4 py-3 text-center text-[11px] font-bold text-slate-500 uppercase tracking-wider w-[8%]">
                順位
              </th>
              <th class="px-6 py-3 text-center text-[11px] font-bold text-slate-500 uppercase tracking-wider w-[9%] bg-blue-50/30">
                選択
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100" id="usecase-body">
            <!-- Use case rows will be rendered here -->
          </tbody>
        </table>
      </div>
      <div class="bg-slate-50 px-6 py-3 border-t border-slate-200 flex justify-between items-center">
        <span class="text-xs text-slate-500" id="usecase-count">候補を追加してください</span>
        <button id="btn-add-usecase" class="flex items-center gap-1 px-3 py-1.5 text-sm font-semibold text-primary hover:bg-blue-50 rounded-md transition-colors">
          <i data-lucide="plus-circle" class="w-4 h-4"></i>
          新規候補を追加
        </button>
      </div>
    </div>
  </main>

  <!-- Sidebar: Scoring Guide -->
  <aside class="w-full lg:w-80 shrink-0 flex flex-col gap-6">
    <div class="bg-white rounded-lg shadow-card border border-border-color sticky top-0">
      <div class="p-5 border-b border-slate-100 bg-slate-50 rounded-t-lg">
        <div class="flex items-center gap-2">
          <i data-lucide="book-open" class="w-5 h-5 text-primary"></i>
          <h3 class="font-bold text-slate-800 text-sm">評価基準ガイド</h3>
        </div>
      </div>
      <div class="p-5 flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <div class="flex items-center justify-between">
            <h4 class="font-bold text-xs text-slate-800 uppercase tracking-wide">1. インパクト</h4>
            <span class="text-[10px] bg-blue-50 text-primary px-2 py-0.5 rounded-full font-bold border border-blue-100">40% Weight</span>
          </div>
          <p class="text-sm text-slate-600 leading-relaxed">
            売上拡大やコスト削減のポテンシャル。ビジネスにどれだけの価値をもたらすかを1-5で評価します。
          </p>
        </div>
        <div class="w-full h-px bg-slate-100"></div>

        <div class="flex flex-col gap-2">
          <div class="flex items-center justify-between">
            <h4 class="font-bold text-xs text-slate-800 uppercase tracking-wide">2. 90日実現性</h4>
            <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-bold border border-slate-200">30% Weight</span>
          </div>
          <p class="text-sm text-slate-600 leading-relaxed">
            技術的・組織的な準備状況。3ヶ月以内に成果を出せる現実性があるかを評価します。
          </p>
        </div>
        <div class="w-full h-px bg-slate-100"></div>

        <div class="flex flex-col gap-2">
          <div class="flex items-center justify-between">
            <h4 class="font-bold text-xs text-slate-800 uppercase tracking-wide">3. 能力構築</h4>
            <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-bold border border-slate-200">30% Weight</span>
          </div>
          <p class="text-sm text-slate-600 leading-relaxed">
            将来のスキル獲得への貢献度。このプロジェクトを通じてチームが成長できるかを評価します。
          </p>
        </div>

        <div class="mt-2 p-3 bg-blue-50 rounded border border-blue-100 flex gap-3 items-start">
          <i data-lucide="info" class="w-4 h-4 text-primary shrink-0 mt-0.5"></i>
          <p class="text-xs text-slate-700">
            <strong>Tip:</strong> スコアはチームで議論しながら入力してください。合計スコアは自動計算されます。
          </p>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Footer Actions -->
<div class="fixed bottom-0 left-0 right-0 md:left-64 bg-white border-t border-border-color shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-40">
  <div class="max-w-[1440px] mx-auto px-6 py-4 flex flex-col sm:flex-row items-center justify-between gap-4">
    <div class="flex items-center gap-6 w-full sm:w-auto">
      <div class="flex flex-col">
        <span class="text-[10px] font-bold uppercase tracking-wider text-primary mb-0.5">Step B</span>
        <h3 class="font-bold text-slate-800 text-base">上位1〜2件を選択</h3>
      </div>
      <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>
      <div class="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
        <div class="flex -space-x-2" id="selected-icons"></div>
        <div class="text-sm font-medium text-slate-600">
          <span class="text-slate-900 font-bold" id="selected-count">0</span> / 2 件選択
        </div>
      </div>
    </div>
    <div class="flex items-center gap-4 w-full sm:w-auto justify-end">
      <p class="text-xs text-slate-500 hidden lg:block italic">選択したユースケースは90日計画へ移行されます。</p>
      <button id="btn-create-plan" class="bg-primary hover:bg-primary-hover text-white font-semibold py-2.5 px-6 rounded-md shadow-sm transition-all flex items-center justify-center gap-2 w-full sm:w-auto text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        <i data-lucide="calendar-plus" class="w-4 h-4"></i>
        90日計画を作成
      </button>
    </div>
  </div>
</div>

<template id="usecase-row-template">
  <tr class="hover:bg-slate-50 transition-colors group" data-usecase-id="">
    <td class="px-6 py-4">
      <div class="flex items-start gap-3">
        <div class="size-8 rounded bg-primary/10 text-primary flex items-center justify-center shrink-0 mt-0.5">
          <i data-lucide="briefcase" class="w-4 h-4"></i>
        </div>
        <div class="flex-1">
          <input type="text" class="font-bold text-slate-800 text-sm bg-transparent border-0 p-0 focus:ring-0 w-full placeholder:text-slate-400" placeholder="ユースケース名" data-field="name"/>
          <input type="text" class="text-xs text-slate-500 mt-0.5 bg-transparent border-0 p-0 focus:ring-0 w-full placeholder:text-slate-400" placeholder="簡単な説明" data-field="description"/>
        </div>
      </div>
    </td>
    <td class="px-4 py-4 align-middle">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-700 w-3 score-display" data-score="impact">3</span>
        <input class="w-full score-range" max="5" min="1" type="range" value="3" data-field="impact"/>
      </div>
    </td>
    <td class="px-4 py-4 align-middle">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-700 w-3 score-display" data-score="feasibility">3</span>
        <input class="w-full score-range" max="5" min="1" type="range" value="3" data-field="feasibility"/>
      </div>
    </td>
    <td class="px-4 py-4 align-middle">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold text-slate-700 w-3 score-display" data-score="capability">3</span>
        <input class="w-full score-range" max="5" min="1" type="range" value="3" data-field="capability"/>
      </div>
    </td>
    <td class="px-4 py-4 text-center border-l border-slate-100 bg-slate-50/30">
      <span class="text-lg font-black text-slate-800 total-score">9</span>
    </td>
    <td class="px-4 py-4 text-center">
      <span class="inline-flex items-center justify-center size-6 rounded-full text-xs font-bold bg-slate-100 text-slate-400 rank-badge">-</span>
    </td>
    <td class="px-6 py-4 text-center bg-blue-50/30 border-l border-blue-100">
      <input type="checkbox" class="size-5 rounded border-slate-300 text-primary focus:ring-primary/20 cursor-pointer transition-all select-checkbox"/>
    </td>
  </tr>
</template>

<style>
.score-range { -webkit-appearance: none; background: transparent; cursor: pointer; }
.score-range::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #0176D3; cursor: pointer; margin-top: -7px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border: 2px solid white; }
.score-range::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E5E7EB; border-radius: 2px; }
.score-range:focus { outline: none; }
.custom-scrollbar::-webkit-scrollbar { height: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
</style>

<script>
(function() {
  const usecaseBody = document.getElementById('usecase-body');
  const template = document.getElementById('usecase-row-template');
  const btnAddUsecase = document.getElementById('btn-add-usecase');
  const btnCreatePlan = document.getElementById('btn-create-plan');
  const selectedCountEl = document.getElementById('selected-count');
  const usecaseCountEl = document.getElementById('usecase-count');
  const selectedIconsEl = document.getElementById('selected-icons');

  let usecases = [];
  let usecaseIdCounter = 0;

  function initDefaultUsecases() {
    const defaults = [
      { name: 'AI カスタマーサポート', description: '自動チケット解決', impact: 4, feasibility: 3, capability: 5 },
      { name: '予知保全', description: 'IoTセンサー分析', impact: 5, feasibility: 2, capability: 4 },
      { name: '売上予測', description: 'AI収益予測', impact: 3, feasibility: 5, capability: 2 },
      { name: '在庫最適化', description: 'サプライチェーン最適化', impact: 2, feasibility: 4, capability: 3 }
    ];
    defaults.forEach(uc => addUsecase(uc));
    updateRankings();
  }

  function addUsecase(data = {}) {
    const id = 'uc-' + (++usecaseIdCounter);
    const usecase = { id, name: data.name || '', description: data.description || '', impact: data.impact || 3, feasibility: data.feasibility || 3, capability: data.capability || 3, selected: false };
    usecases.push(usecase);
    renderUsecase(usecase);
    updateUsecaseCount();
    return usecase;
  }

  function renderUsecase(usecase) {
    const clone = template.content.cloneNode(true);
    const row = clone.querySelector('tr');
    row.dataset.usecaseId = usecase.id;
    row.querySelector('[data-field="name"]').value = usecase.name;
    row.querySelector('[data-field="description"]').value = usecase.description;
    row.querySelector('[data-field="impact"]').value = usecase.impact;
    row.querySelector('[data-field="feasibility"]').value = usecase.feasibility;
    row.querySelector('[data-field="capability"]').value = usecase.capability;
    row.querySelector('[data-score="impact"]').textContent = usecase.impact;
    row.querySelector('[data-score="feasibility"]').textContent = usecase.feasibility;
    row.querySelector('[data-score="capability"]').textContent = usecase.capability;
    row.querySelector('.total-score').textContent = usecase.impact + usecase.feasibility + usecase.capability;

    row.querySelectorAll('.score-range').forEach(range => {
      range.addEventListener('input', function() {
        const field = this.dataset.field;
        const value = parseInt(this.value);
        usecase[field] = value;
        row.querySelector('[data-score="' + field + '"]').textContent = value;
        row.querySelector('.total-score').textContent = usecase.impact + usecase.feasibility + usecase.capability;
        updateRankings();
      });
    });

    row.querySelector('.select-checkbox').addEventListener('change', function() {
      usecase.selected = this.checked;
      updateSelection();
    });

    row.querySelector('[data-field="name"]').addEventListener('input', function() { usecase.name = this.value; });
    row.querySelector('[data-field="description"]').addEventListener('input', function() { usecase.description = this.value; });

    usecaseBody.appendChild(row);
    if (window.lucide) lucide.createIcons({ nameAttr: 'data-lucide' });
  }

  function updateRankings() {
    const sorted = [...usecases].sort((a, b) => (b.impact + b.feasibility + b.capability) - (a.impact + a.feasibility + a.capability));
    sorted.forEach((uc, index) => {
      const row = usecaseBody.querySelector('[data-usecase-id="' + uc.id + '"]');
      if (row) {
        const badge = row.querySelector('.rank-badge');
        badge.textContent = index + 1;
        badge.className = index === 0 ? 'inline-flex items-center justify-center size-6 rounded-full text-xs font-bold bg-amber-500 text-white shadow-sm' : index === 1 ? 'inline-flex items-center justify-center size-6 rounded-full text-xs font-bold bg-slate-200 text-slate-600' : 'inline-flex items-center justify-center size-6 rounded-full text-xs font-bold bg-slate-100 text-slate-400';
        row.classList.toggle('bg-blue-50/20', index === 0);
      }
    });
  }

  function updateSelection() {
    const selected = usecases.filter(uc => uc.selected);
    selectedCountEl.textContent = selected.length;
    btnCreatePlan.disabled = selected.length === 0;
    selectedIconsEl.innerHTML = selected.slice(0, 2).map(uc => '<div class="size-6 rounded-full bg-primary text-white flex items-center justify-center text-[10px] font-bold shadow-sm ring-2 ring-white">' + (uc.name ? uc.name.charAt(0).toUpperCase() : 'U') + '</div>').join('');
  }

  function updateUsecaseCount() {
    usecaseCountEl.textContent = usecases.length + ' 件の候補';
  }

  if (btnAddUsecase) btnAddUsecase.addEventListener('click', function() { addUsecase(); updateRankings(); });
  if (btnCreatePlan) btnCreatePlan.addEventListener('click', function() {
    const selected = usecases.filter(uc => uc.selected);
    if (selected.length > 0 && typeof App !== 'undefined' && App.navigate) App.navigate('90daysplan');
  });

  initDefaultUsecases();
})();
</script>
